---
import { Card, CardGrid } from '@astrojs/starlight/components';

interface Plugin {
	id: string;
	name: string;
	version: string;
	author: string;
	description: string;
	repository: string;
	minNoctaliaVersion?: string;
	license?: string;
}

interface Registry {
	version: number;
	plugins: Plugin[];
}

let plugins: Plugin[] = [];

try {
	const res = await fetch('https://raw.githubusercontent.com/noctalia-dev/noctalia-plugins/main/registry.json', {
		headers: { Accept: 'application/json' },
	});
	if (res.ok) {
		const data: Registry = await res.json();
		plugins = data.plugins || [];
	} else {
		plugins = [];
	}
} catch (e) {
	plugins = [];
}

---

<div class="plugins-container">
	<div class="plugins-header">
		<div class="plugins-search-wrapper">
			<div class="plugins-search-container">
				<svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="11" cy="11" r="8"></circle>
					<path d="m21 21-4.35-4.35"></path>
				</svg>
				<input
					type="search"
					id="plugin-search"
					placeholder="Search plugins by name, description, or author... (Press / to focus)"
					class="plugins-search-input"
					aria-label="Search plugins"
				/>
				<span id="search-results-count" class="search-results-count"></span>
			</div>
		</div>
	</div>
	
	<div id="plugins-grid-container">
		{plugins && plugins.length > 0 ? (
			<CardGrid id="plugins-grid" class="plugins-grid">
				{plugins.map((plugin: Plugin, index: number) => {
					// Construct URL to plugin folder: {repository}/tree/main/{id}
					const pluginUrl = `${plugin.repository}/tree/main/${plugin.id}`;
					return (
					<div class="plugin-card" data-plugin-name={plugin.name.toLowerCase()} data-plugin-description={plugin.description.toLowerCase()} data-plugin-author={(plugin.author || '').toLowerCase()} style={{ position: 'relative', animationDelay: `${index * 0.05}s` }}>
						<Card>
							<div class="plugin-title">
								<h3 class="plugin-name">{plugin.name}</h3>
								<svg class="plugin-external-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
									<polyline points="15 3 21 3 21 9"></polyline>
									<line x1="10" y1="14" x2="21" y2="3"></line>
								</svg>
							</div>
							<p class="plugin-description">{plugin.description}</p>
							<div class="plugin-metadata">
								<div class="plugin-badges">
									<span class="plugin-badge version-badge" title="Plugin version">
										<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
											<line x1="7" y1="7" x2="7.01" y2="7"></line>
										</svg>
										v{plugin.version}
									</span>
									{plugin.minNoctaliaVersion && (
										<span class="plugin-badge noctalia-badge" title="Minimum Noctalia version">
											<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
												<polyline points="22 4 12 14.01 9 11.01"></polyline>
											</svg>
											v{plugin.minNoctaliaVersion}+
										</span>
									)}
									{plugin.license && (
										<span class="plugin-badge license-badge" title="License">
											<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
												<polyline points="14 2 14 8 20 8"></polyline>
												<line x1="16" y1="13" x2="8" y2="13"></line>
												<line x1="16" y1="17" x2="8" y2="17"></line>
												<polyline points="10 9 9 9 8 9"></polyline>
											</svg>
											{plugin.license}
										</span>
									)}
									{plugin.author && (
										<span class="plugin-badge author-badge" title="Author">
											<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
												<circle cx="12" cy="7" r="4"></circle>
											</svg>
											{plugin.author}
										</span>
									)}
								</div>
							</div>
						</Card>
						<a href={pluginUrl} target="_blank" rel="noopener noreferrer" aria-label={`Open ${plugin.name} plugin`} class="plugin-card-link" />
					</div>
					);
				})}
			</CardGrid>
		) : (
			<div class="plugins-empty">
				<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
					<polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
					<line x1="12" y1="22.08" x2="12" y2="12"></line>
				</svg>
				<p>No plugins found. Try again later.</p>
			</div>
		)}
	</div>
	
	<div id="plugins-no-results" class="plugins-no-results">
		<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
			<circle cx="11" cy="11" r="8"></circle>
			<path d="m21 21-4.35-4.35"></path>
			<line x1="11" y1="8" x2="11" y2="12"></line>
			<line x1="11" y1="16" x2="11.01" y2="16"></line>
		</svg>
		<p>No plugins match your search.</p>
		<p class="no-results-hint">Try different keywords or clear your search.</p>
	</div>
</div>

<script>
	function initPluginSearch() {
		const searchInput = document.getElementById('plugin-search') as HTMLInputElement;
		const pluginsGrid = document.getElementById('plugins-grid');
		const noResults = document.getElementById('plugins-no-results');
		const resultsCount = document.getElementById('search-results-count');
		
		if (!searchInput) return;
		
		function updateSearch() {
			const query = searchInput.value.toLowerCase().trim();
			const pluginCards = document.querySelectorAll('.plugin-card');
			let visibleCount = 0;
			
			pluginCards.forEach((card, index) => {
				const name = card.getAttribute('data-plugin-name') || '';
				const description = card.getAttribute('data-plugin-description') || '';
				const author = card.getAttribute('data-plugin-author') || '';
				
				const matches = query === '' || 
					name.includes(query) || 
					description.includes(query) || 
					author.includes(query);
				
				if (matches) {
					card.classList.remove('hidden');
					// Add staggered animation
					(card as HTMLElement).style.animationDelay = `${visibleCount * 0.03}s`;
					visibleCount++;
				} else {
					card.classList.add('hidden');
				}
			});
			
			if (pluginsGrid) {
				pluginsGrid.style.display = visibleCount > 0 ? '' : 'none';
			}
			if (noResults) {
				noResults.style.display = visibleCount === 0 && query !== '' ? 'flex' : 'none';
			}
			if (resultsCount) {
				if (query === '') {
					resultsCount.textContent = '';
				} else {
					resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'result' : 'results'}`;
				}
			}
		}
		
		searchInput.addEventListener('input', updateSearch);
		
		// Keyboard shortcut: focus search with /
		document.addEventListener('keydown', (e) => {
			if (e.key === '/' && e.target === document.body) {
				e.preventDefault();
				searchInput.focus();
			}
			// Escape to clear search
			if (e.key === 'Escape' && document.activeElement === searchInput) {
				searchInput.value = '';
				updateSearch();
			}
		});
		
	}
	
	// Wait for DOM to be ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initPluginSearch);
	} else {
		initPluginSearch();
	}
</script>

<style>
	.plugins-container {
		width: 100%;
		max-width: 100%;
	}
	
	.plugins-header {
		margin-bottom: 2.5rem;
		display: flex;
		justify-content: center;
	}
	
	.plugins-search-wrapper {
		width: 100%;
		display: flex;
		justify-content: center;
		max-width: 600px;
	}
	
	.plugins-search-container {
		position: relative;
		width: 100%;
		display: flex;
		align-items: center;
	}
	
	.search-icon {
		position: absolute;
		left: 1rem;
		color: var(--sl-color-text-soft);
		pointer-events: none;
		z-index: 1;
	}
	
	.plugins-search-input {
		width: 100%;
		padding: 0.875rem 1rem 0.875rem 3rem;
		font-size: 1rem;
		border: 1px solid var(--sl-color-hairline);
		border-radius: var(--sl-border-radius);
		background-color: var(--sl-color-bg);
		color: var(--sl-color-text);
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		backdrop-filter: blur(10px);
	}
	
	.plugins-search-input:hover {
		border-color: var(--sl-color-accent);
		box-shadow: 0 2px 8px var(--sl-shadow-color);
	}
	
	.plugins-search-input:focus {
		outline: none;
		border-color: var(--sl-color-accent);
		box-shadow: 0 0 0 3px var(--sl-color-accent), 0 4px 12px var(--sl-shadow-color);
		transform: translateY(-1px);
	}
	
	.plugins-search-input:focus + .search-results-count,
	.plugins-search-input:not(:placeholder-shown) + .search-results-count {
		opacity: 1;
	}
	
	.plugins-search-input::placeholder {
		color: var(--sl-color-text-soft);
	}
	
	.search-results-count {
		position: absolute;
		right: 1rem;
		color: var(--sl-color-text-soft);
		font-size: 0.875rem;
		opacity: 0;
		transition: opacity 0.2s ease;
		pointer-events: none;
	}
	
	.plugins-grid {
		transition: opacity 0.2s ease;
	}
	
	.plugin-card {
		animation: fadeInUp 0.5s ease-out backwards;
		transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
		            box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
		            filter 0.3s cubic-bezier(0.4, 0, 0.2, 1),
		            opacity 0.3s ease;
	}
	
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
	
	.plugin-card.hidden {
		display: none;
		animation: none;
	}
	
	.plugin-card article {
		height: 100%;
		display: flex;
		flex-direction: column;
		position: relative;
		overflow: hidden;
	}
	
	.plugin-title {
		display: flex;
		align-items: baseline;
		gap: 0.5rem;
		margin-bottom: 0.75rem;
	}
	
	.plugin-name {
		margin: 0;
		font-size: 1.25rem;
		font-weight: 600;
		color: var(--sl-color-text);
		line-height: 1.2;
	}
	
	.plugin-external-icon {
		flex-shrink: 0;
		color: var(--sl-color-text-soft);
		transition: all 0.2s ease;
		position: relative;
		top: 0.125rem;
	}
	
	.plugin-card:hover .plugin-external-icon {
		color: var(--sl-color-accent);
		transform: translate(2px, -2px);
	}
	
	.plugin-card article::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		height: 3px;
		background: linear-gradient(90deg, 
			var(--sl-color-accent), 
			var(--sl-color-link-hover));
		opacity: 0;
		transition: opacity 0.3s ease;
	}
	
	.plugin-card:hover article::before {
		opacity: 1;
	}
	
	.plugin-description {
		margin-bottom: 1rem;
		color: var(--sl-color-text);
		line-height: 1.6;
	}
	
	.plugin-metadata {
		margin-bottom: 1rem;
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}
	
	.plugin-badges {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}
	
	.plugin-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.375rem;
		padding: 0.375rem 0.625rem;
		background: var(--sl-color-bg-soft);
		border: 1px solid var(--sl-color-hairline);
		border-radius: calc(var(--sl-border-radius) * 0.6);
		font-size: 0.75rem;
		color: var(--sl-color-text-soft);
		font-weight: 500;
		transition: all 0.2s ease;
	}
	
	.plugin-badge:hover {
		background: var(--sl-color-bg);
		border-color: var(--sl-color-accent);
		transform: translateY(-1px);
	}
	
	.plugin-badge svg {
		flex-shrink: 0;
	}
	
	
	.plugin-card-link {
		position: absolute;
		inset: 0;
		z-index: 5;
		border-radius: inherit;
	}
	
	.plugins-empty,
	.plugins-no-results {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 4rem 2rem;
		text-align: center;
		color: var(--sl-color-text-soft);
	}
	
	.plugins-empty svg,
	.plugins-no-results svg {
		margin-bottom: 1.5rem;
		opacity: 0.5;
	}
	
	.plugins-no-results {
		display: none;
	}
	
	.no-results-hint {
		margin-top: 0.5rem;
		font-size: 0.875rem;
		opacity: 0.7;
	}
	
	@media (max-width: 768px) {
		.plugins-search-container {
			max-width: 100%;
		}
	}
</style>

